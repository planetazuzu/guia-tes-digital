#!/bin/bash
# Hook post-receive para despliegue autom√°tico
# Ubicaci√≥n: /var/repos/emerges-tes.git/hooks/post-receive

set -e  # Salir si hay error

# Configuraci√≥n
APP_DIR="/var/www/emerges-tes"
GIT_DIR="/var/repos/emerges-tes.git"
BRANCH="main"
LOG_FILE="/var/log/emerges-tes-deploy.log"

# Funci√≥n de logging
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
}

log "=========================================="
log "üöÄ Iniciando despliegue autom√°tico"
log "=========================================="

# Leer la rama que se est√° actualizando
while read oldrev newrev refname; do
    # Usar GIT_DIR para obtener el nombre de la rama desde el repositorio bare
    branch=$(git --git-dir="$GIT_DIR" rev-parse --symbolic --abbrev-ref $refname 2>/dev/null || echo "$refname" | sed 's|refs/heads/||')
    
    if [ "$branch" = "$BRANCH" ]; then
        log "üì¶ Actualizando rama: $branch"
        log "   Commit anterior: $oldrev"
        log "   Commit nuevo: $newrev"
        
        # Verificar que el directorio de trabajo existe
        if [ ! -d "$APP_DIR" ]; then
            log "‚ùå ERROR: Directorio $APP_DIR no existe"
            exit 1
        fi
        
        # Ir al directorio de trabajo
        cd "$APP_DIR" || {
            log "‚ùå ERROR: No se puede acceder a $APP_DIR"
            exit 1
        }
        
        # Usar git directamente con --work-tree y --git-dir para evitar problemas de work tree
        # Esto funciona tanto si APP_DIR es un repositorio git como si no lo es
        
        # Si no existe .git, inicializar o clonar
        if [ ! -d "$APP_DIR/.git" ]; then
            log "‚ö†Ô∏è  $APP_DIR no es un repositorio git, clonando..."
            # Si el directorio tiene contenido, hacer backup o limpiar
            if [ "$(ls -A $APP_DIR 2>/dev/null)" ]; then
                log "‚ö†Ô∏è  Directorio no vac√≠o, haciendo backup..."
                mv "$APP_DIR" "${APP_DIR}.backup.$(date +%s)" 2>/dev/null || true
            fi
            # Clonar desde el repositorio bare
            git clone "$GIT_DIR" "$APP_DIR" || {
                log "‚ùå ERROR: No se pudo clonar repositorio"
                exit 1
            }
            cd "$APP_DIR" || exit 1
            git checkout "$BRANCH" || {
                log "‚ùå ERROR: No se pudo hacer checkout de $BRANCH"
                exit 1
            }
        else
            # Si ya es un repositorio, usar git normal
            cd "$APP_DIR" || exit 1
            
            # Obtener los √∫ltimos cambios
            log "üì• Obteniendo cambios del repositorio..."
            git fetch "$GIT_DIR" "$BRANCH" || {
                log "‚ùå ERROR: Fallo al hacer fetch"
                exit 1
            }
            
            # Resetear a la versi√≥n m√°s reciente (checkout limpio)
            log "üîÑ Haciendo checkout limpio..."
            git reset --hard "FETCH_HEAD" || {
                log "‚ùå ERROR: Fallo al hacer reset"
                exit 1
            }
        fi
        
        # Limpiar archivos no rastreados (opcional, pero recomendado)
        log "üßπ Limpiando archivos no rastreados..."
        git clean -fd || {
            log "‚ö†Ô∏è  ADVERTENCIA: Fallo al limpiar archivos"
        }
        
        # Instalar dependencias
        log "üì¶ Instalando dependencias (npm install)..."
        if ! npm install --production=false 2>&1 | tee -a "$LOG_FILE"; then
            log "‚ùå ERROR: Fallo al instalar dependencias"
            exit 1
        fi
        log "‚úÖ Dependencias instaladas correctamente"
        
        # Build de producci√≥n
        log "üî® Construyendo aplicaci√≥n (npm run build)..."
        if ! npm run build 2>&1 | tee -a "$LOG_FILE"; then
            log "‚ùå ERROR: Fallo al construir la aplicaci√≥n"
            exit 1
        fi
        log "‚úÖ Build completado correctamente"
        
        # Verificar que el build se cre√≥
        if [ ! -d "$APP_DIR/dist" ]; then
            log "‚ùå ERROR: El directorio dist/ no existe despu√©s del build"
            exit 1
        fi
        
        log "‚úÖ Despliegue completado exitosamente"
        log "   Aplicaci√≥n disponible en: $APP_DIR/dist"
        log "=========================================="
        
        exit 0
    else
        log "‚è≠Ô∏è  Ignorando push en rama: $branch (solo se despliega $BRANCH)"
    fi
done

log "‚ö†Ô∏è  No se proces√≥ ning√∫n cambio"
exit 0

